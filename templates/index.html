<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat con Mar-IA-Jose</title>    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-mode.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/files-panel.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/markdown.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/upload-queue.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/queue-panel.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/math.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax para renderizar LaTeX -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };
    </script>
</head>
<body data-is-admin="{{ 'true' if is_admin else 'false' }}">
    <div class="app-container">
        <div class="sidebar">
            <div class="user-header">
                <div class="user-identity">
                    <div class="user-menu">
                        <button id="user-menu-toggle" class="user-menu-toggle" aria-haspopup="true" aria-expanded="false" aria-controls="user-menu-dropdown">
                            <i class="fas fa-bars" aria-hidden="true"></i>
                            <span class="sr-only">Abrir men√∫ de usuario</span>
                        </button>
                        <div id="user-menu-dropdown" class="user-menu-dropdown" role="menu" aria-hidden="true">
                            {% if is_admin %}
                            <button type="button" class="user-menu-item" data-action="manage-users" role="menuitem">
                                <i class="fas fa-users-gear" aria-hidden="true"></i>
                                <span>Administrar usuarios</span>
                            </button>
                            {% endif %}
                            <button type="button" class="user-menu-item" data-action="change-password" role="menuitem">
                                <i class="fas fa-key" aria-hidden="true"></i>
                                <span>Cambiar contrase√±a</span>
                            </button>
                            <a href="{{ url_for('logout') }}" class="user-menu-item" role="menuitem">
                                <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                                <span>Cerrar sesi√≥n</span>
                            </a>
                        </div>
                    </div>
                    <span class="username">{{ current_user.username}}</span>
                </div>
                <div class="user-actions">
                    <button id="theme-toggle" class="theme-toggle" aria-label="Cambiar tema">üåô</button>
                </div>
            </div>
            <div class="sidebar-header">
                <h2>Mis Conversaciones</h2>
                <div class="sidebar-actions">
                    <button id="new-chat-btn" class="new-chat-btn">Nueva Conversaci√≥n</button>
                </div>
            </div>
            <div class="chat-list">
                {% for chat in chats %}
                <div class="chat-item" data-id="{{ chat.id }}">
                    <div class="chat-content">
                        <div class="chat-preview">{{ chat.preview }}</div>
                        <div class="chat-date">{{ chat.timestamp }}</div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn rename-chat" title="Renombrar chat">‚úèÔ∏è</button>
                        <button class="chat-action-btn delete-chat" title="Eliminar chat">üóëÔ∏è</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="main-content">
            <div class="chat-container">                <div class="chat-messages" id="chat-messages">
                    <!-- El mensaje de bienvenida ahora se maneja din√°micamente desde JavaScript -->
                </div>
                <div class="chat-input-container">
                    <textarea id="chat-input" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                    <button id="send-btn">Enviar</button>
                </div>
                <div class="bottom-toolbar">
                    <div class="file-upload-container">
                        <label for="file-upload" class="file-upload-label">
                            <span class="upload-icon">üìé</span>
                            <span>Subir archivo</span>
                        </label>
                        <input type="file" id="file-upload" class="file-upload-input" accept=".pdf,.txt,.md,.csv,.docx,.jpg,.jpeg,.png,.gif" multiple>
                    </div>
                    <button id="camera-btn" class="toolbar-btn">
                        <span class="camera-icon">üì∑</span>
                        <span>C√°mara</span>
                    </button>
                    <div id="upload-status" class="upload-status"></div>
                    <button id="files-toggle-toolbar" class="toolbar-btn">üìÅ Ver archivos</button>
                    <button id="queue-toggle-toolbar" class="toolbar-btn">üîÑ Ver cola</button>
                    <div class="model-selection-group">
                        <label for="model-select">Modelo:</label>
                        <select id="model-select" class="model-select">
                            <!-- Los modelos se cargar√°n din√°micamente -->
                        </select>
                        <button id="system-message-btn" class="system-message-btn">‚öôÔ∏è Mensaje del Sistema</button>
                    </div>
                    <div class="rag-settings-group">
                        <label for="rag-top-k">Top K:</label>
                        <input type="number" id="rag-top-k" class="rag-number-input" min="1" max="20" value="3">
                        <label for="temperature-input">Temperatura:</label>
                        <input type="number" id="temperature-input" class="rag-number-input" min="0" max="2" step="0.1" value="1.0">
                        <label for="message-history-limit">Mensajes:</label>
                        <input type="number" id="message-history-limit" class="rag-number-input" min="1" max="50" value="10">
                    </div>
                    <div class="toolbar-version" role="status" aria-label="Versi√≥n de la aplicaci√≥n">
                        <span class="toolbar-version-label">V:</span>
                        <span class="toolbar-version-value">{{ app_version }}</span>
                    </div>
                    <button id="help-btn" class="toolbar-btn help-btn" title="Ayuda">
                        <i class="fas fa-question-circle"></i>
                        <span>Ayuda</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de archivos desplegable -->
    <div class="files-panel" id="files-panel">
        <div class="files-panel-header">
            <h3 class="files-panel-title">Archivos Subidos</h3>
            <button class="files-panel-close" id="files-panel-close">√ó</button>
        </div>
        <div class="files-list" id="files-list">
            <!-- Los archivos se cargar√°n din√°micamente -->
        </div>
    </div>
    
    <!-- Panel de cola de procesamiento -->
    <div class="queue-panel" id="queue-panel">
        <div class="queue-panel-header">
            <h3 class="queue-panel-title">Cola de Procesamiento</h3>
            <button class="queue-panel-close" id="queue-panel-close">√ó</button>
        </div>
        <div class="queue-list" id="queue-list">
            <!-- La cola de procesamiento se cargar√° din√°micamente -->
        </div>
    </div>
    
    <!-- Modal para configurar mensaje del sistema -->
    <div class="modal" id="system-message-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configurar Mensaje del Sistema</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Personaliza el mensaje del sistema para este chat:</p>
                <label for="saved-prompts-select" class="system-prompts-label">Mis prompts guardados</label>
                <select id="saved-prompts-select" class="system-prompts-select">
                    <option value="">Cargando prompts guardados...</option>
                </select>
                <div id="system-prompts-feedback" class="system-prompts-feedback" role="status" aria-live="polite"></div>
                <div class="system-prompt-editor">
                    <textarea id="system-message-input" placeholder="Eres un asistente √∫til que responde a las preguntas del usuario de manera clara y concisa."></textarea>
                    <div class="system-prompt-inline-actions">
                        <button id="store-system-prompt-btn" type="button" class="secondary-btn">Guardar</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-system-message-btn" class="primary-btn">Aplicar</button>
                <button class="cancel-btn modal-close">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para cambiar contrase√±a -->
    <div class="modal" id="change-password-modal" role="dialog" aria-modal="true" aria-labelledby="change-password-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="change-password-title">Cambiar contrase√±a</h3>
                <button class="modal-close" type="button" aria-label="Cerrar">&times;</button>
            </div>
            <div class="modal-body">
                <form id="change-password-form" class="change-password-form">
                    <label for="current-password">Contrase√±a actual</label>
                    <input type="password" id="current-password" name="current_password" autocomplete="current-password" required>

                    <label for="new-password">Nueva contrase√±a</label>
                    <input type="password" id="new-password" name="new_password" autocomplete="new-password" minlength="8" required>

                    <label for="confirm-new-password">Confirmar nueva contrase√±a</label>
                    <input type="password" id="confirm-new-password" name="confirm_new_password" autocomplete="new-password" minlength="8" required>

                    <div id="change-password-feedback" class="change-password-feedback" role="status" aria-live="polite"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="change-password-submit" class="primary-btn" type="submit" form="change-password-form">Actualizar contrase√±a</button>
                <button class="cancel-btn modal-close" type="button">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para administrar usuarios -->
    <div class="modal" id="manage-users-modal" role="dialog" aria-modal="true" aria-labelledby="manage-users-title">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3 id="manage-users-title">Administrar usuarios</h3>
                <button class="modal-close" type="button" aria-label="Cerrar">&times;</button>
            </div>
            <div class="modal-body">
                <p class="manage-users-description">Gestiona cuentas existentes. Puedes restablecer contrase√±as, eliminar usuarios y marcar la casilla "Administrador" para otorgar o revocar ese permiso.</p>
                <div id="manage-users-feedback" class="manage-users-feedback" role="status" aria-live="polite"></div>
                <div class="manage-users-table-wrapper">
                    <table class="manage-users-table" aria-describedby="manage-users-title">
                        <colgroup>
                            <col class="manage-users-col-user">
                            <col class="manage-users-col-role">
                            <col class="manage-users-col-email">
                            <col class="manage-users-col-created">
                            <col class="manage-users-col-actions">
                        </colgroup>
                        <thead>
                            <tr>
                                <th scope="col">Usuario</th>
                                <th scope="col">Rol / Admin</th>
                                <th scope="col">Correo</th>
                                <th scope="col">Creado</th>
                                <th scope="col" class="manage-users-actions-header">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="manage-users-table-body">
                            <tr>
                                <td colspan="5" class="manage-users-empty">Cargando informaci√≥n‚Ä¶</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="admin-reset-password" id="admin-reset-password-section" hidden>
                    <h4 id="admin-reset-password-title">Resetear contrase√±a</h4>
                    <p class="admin-reset-password-target">Usuario seleccionado: <strong id="admin-reset-target-name"></strong></p>
                    <form id="admin-reset-password-form" class="admin-reset-password-form" aria-labelledby="admin-reset-password-title">
                        <label for="admin-reset-password">Nueva contrase√±a</label>
                        <input type="password" id="admin-reset-password" name="new_password" minlength="8" autocomplete="new-password" required>

                        <label for="admin-reset-password-confirm">Confirmar nueva contrase√±a</label>
                        <input type="password" id="admin-reset-password-confirm" name="confirm_new_password" minlength="8" autocomplete="new-password" required>

                        <div id="admin-reset-password-feedback" class="admin-reset-password-feedback" role="status" aria-live="polite"></div>

                        <div class="admin-reset-password-actions">
                            <button type="submit" class="primary-btn">Guardar nueva contrase√±a</button>
                            <button type="button" class="cancel-btn" id="admin-reset-password-cancel">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" type="button" data-role="close-manage-users">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para renombrar chat -->
    <div class="modal" id="rename-chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Renombrar Chat</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Introduce un nuevo nombre para este chat:</p>
                <input type="text" id="chat-title-input" placeholder="Nombre del chat">
            </div>
            <div class="modal-footer">
                <button id="save-chat-title-btn" class="primary-btn">Guardar</button>
                <button class="cancel-btn modal-close">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para opciones de procesamiento de PDF -->
    <div class="modal" id="pdf-options-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Opciones de Procesamiento de PDF</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Selecciona c√≥mo quieres procesar este archivo PDF:</p>
                <div class="pdf-options">
                    <div class="option">
                        <input type="radio" id="process-with-ocr" name="pdf-process-option" value="true" checked>
                        <label for="process-with-ocr">Procesar texto y realizar OCR en im√°genes</label>
                        <p class="option-description">Extrae el texto del PDF y tambi√©n analiza las im√°genes para extraer su contenido textual.</p>
                    </div>
                    <div class="option">
                        <input type="radio" id="process-text-only" name="pdf-process-option" value="false">
                        <label for="process-text-only">Procesar solo el texto del PDF</label>
                        <p class="option-description">Extrae solo el texto del PDF, ignorando el contenido de las im√°genes.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="process-pdf-btn" class="primary-btn">Procesar</button>
                <button class="cancel-btn modal-close">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>